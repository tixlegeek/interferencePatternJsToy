<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title> interferencePatternJsToy</title>
  <meta name="description" content="interferencePatternJsToy">
  <meta name="author" content="tixlegeek">

  <style>
  .rangeCombo {
    clear:both;
    border: 1px solid #888;
    border-radius: 5px;
    box-sizing: border-box;
    width: 450px;
    padding: 5px;
    margin:5px;
    display: inline-block;
  }

  .rangeCombo input[type=checkbox]
  {
    border: 2px solid #fff;
  }

  #video {
    padding: 5px;
    width: 1024px;
    clear:both;
    border: 1px solid #888;
    border-radius: 5px;
    box-sizing: border-box;
    margin: auto;
    margin-bottom: 10px;
  }
  #video canvas{
    display: block;
    margin: 10px auto;
    padding: 5px;
    border: 1px solid #888;
    width:90%;
  }

  #title {
    padding: 5px;
    width: 1024px;
    clear:both;
    border: 1px solid #888;
    border-radius: 5px;
    box-sizing: border-box;
    margin: auto;
  }
  #controls {
    padding: 5px;
    width: 1024px;
    clear:both;
    border: 1px solid #888;
    border-radius: 5px;
    box-sizing: border-box;
    margin: auto;
  }
  </style>
</head>

<body>
  <div id="title">
    <h1>Simple interference pattern visualisation tool</h1>
    <h2>About:</h2>
    <p>
      Developped on the 03-05-2020, by <a href="https://twitter.com/tixlegeek/">@tixlegeek</a> (aka <a href="https://twitter.com/captnlarzuk/">@captnlarzuk</a> ).
    </p>
    <p>
      Simple and dirty JS toy which lets you play with interference patterns.

      This code is absolutely not finished, or cleaned up, and i got no time today for that.
    </p>
    <h2>About physics:</h2>
    <p>
      I can't say it's a physics-accurate representation. I made that for quick testings, but, i guess i now have to think about the "simulation" side. For example, you can't yet simulate reverberation, diffraction, etc... just isotropic emmiters, with a Frequency, a Phase, and an Amplitude (which you can tweak). You also can try to move them around, but, beware, the selector is a ring-buffer, so using it is a pain in the ass.
    </p>
    <p>
      Yes, UI is aweful. Have fun!
    </p>
  </div>
  <div id="video">
    <p>Selection and displacement of emmitters is a rotating buffer. Click and drag to experience the true bontempi UI.</p>
    <canvas id="canvas" width="320" height="200" >
    </canvas>
  </div>
  <div id="controls">
    <div class="rangeCombo" >
      <label for="globalrate">Animation rate:</label>
      <input type="range" id="globalrate" name="globalrate" value="0.05" min="-1" max="1" step="0.05"></input>
    </div>
    <div class="rangeCombo" >
      <label for="drawNullPattern">Draw null patterns:</label>
      <input type="checkbox" id="drawNullPattern" name="sdrawNullPattern" >
    </div>

  </div>
  <script>
  var intRand = function(i){
    return Math.floor(Math.random() * Math.floor(i));
  }
  var globaltimer=0;
  var globalrate=0.05;
  document.getElementById("globalrate").addEventListener("input", function(e){
    globalrate = this.value*1;
  });

  var drawNullPattern = false;
  document.getElementById("drawNullPattern").checked=drawNullPattern;
  document.getElementById("drawNullPattern").addEventListener("change", function(e){
    drawNullPattern = this.checked;
  });
  var canvas =  document.getElementById('canvas');

  var WIDTH = canvas.width;
  var HEIGHT = canvas.height;
  var emmitter = function(x,y,step, phase=0, f=100, a=50, active=false){
    this.x = x;
    this.y = y;

    this.f = f;
    this.a = a;
    this.phase = phase;
    this.step = step;
    this.d = 0;

    this.animate = false;
    this.offset = 0;
    this.checked = active;

    this.checkedinput=document.createElement("INPUT");
    this.animateinput=document.createElement("INPUT");
    this.ainput=document.createElement("INPUT");
    this.adiv=document.createElement("DIV");
    this.finput=document.createElement("INPUT");
    this.fdiv=document.createElement("DIV");
    this.pinput=document.createElement("INPUT");
    this.pdiv=document.createElement("DIV");
    this.div=document.createElement("DIV");

    this.drawControls = function(){
      var self=this;
      this.div.classList.add("rangeCombo");

      var checkedlabel = document.createElement("LABEL");
      checkedlabel.setAttribute("for", "active");
      checkedlabel.innerHTML="Active";
      this.checkedinput.classList.add("active");
      this.checkedinput.setAttribute("type", "checkbox");
      this.checkedinput.setAttribute("name", "check");
      this.checkedinput.setAttribute("max", 100);
      this.checkedinput.setAttribute("min", 0);
      this.checkedinput.setAttribute("step", 1);
      this.checkedinput.checked = this.checked;
      this.div.appendChild(checkedlabel);
      this.div.appendChild(this.checkedinput);
      this.checkedinput.addEventListener("click", function(e){
        self.checked = this.checked;
      });

      var animatelabel = document.createElement("LABEL");
      animatelabel.setAttribute("for", "animate");
      animatelabel.innerHTML="Animate";
      this.animateinput.classList.add("ampl_range");
      this.animateinput.setAttribute("type", "checkbox");
      this.animateinput.setAttribute("name", "animate");
      this.animateinput.setAttribute("max", 100);
      this.animateinput.setAttribute("min", 0);
      this.animateinput.setAttribute("step", 1);
      this.animateinput.checked = this.animate;
      this.div.appendChild(animatelabel);
      this.div.appendChild(this.animateinput);
      this.animateinput.addEventListener("click", function(e){
        self.animate = this.checked;
      });

      var alabel = document.createElement("LABEL");
      alabel.setAttribute("for", "ampl");
      alabel.innerHTML="Power:";
      this.ainput.classList.add("ampl_range");
      this.ainput.setAttribute("type", "range");
      this.ainput.setAttribute("namefalse", "ampl");
      this.ainput.setAttribute("max", 100);
      this.ainput.setAttribute("min", 0);
      this.ainput.setAttribute("step", 1);
      this.ainput.value = this.a;
      this.adiv.appendChild(alabel);
      this.adiv.appendChild(this.ainput);
      this.div.appendChild(this.adiv);
      this.ainput.addEventListener("input", function(e){
        self.a = this.value*1;
      });

      var flabel = document.createElement("LABEL");
      flabel.setAttribute("for", "freq");
      flabel.innerHTML="Frequency:";
      this.finput.classList.add("freq_range");
      this.finput.setAttribute("type", "range");
      this.finput.setAttribute("name", "freq");
      this.finput.setAttribute("max", 300);
      this.finput.setAttribute("min", 0);
      this.finput.setAttribute("step", 1);
      this.finput.value = this.f;
      this.fdiv.appendChild(flabel);
      this.fdiv.appendChild(this.finput);
      this.div.appendChild(this.fdiv);
      this.finput.addEventListener("input", function(e){
        self.f = this.value*1;
      });

      var plabel = document.createElement("LABEL");
      plabel.setAttribute("for", "phas");
      plabel.innerHTML="Phase:";
      this.pinput.classList.add("phas_range");
      this.pinput.setAttribute("type", "range");
      this.pinput.setAttribute("name", "phas");
      this.pinput.setAttribute("max", 2*Math.PI*100);
      this.pinput.setAttribute("min", 0);
      this.pinput.setAttribute("step", 1);
      this.pinput.value = this.p;
      this.pdiv.appendChild(plabel);
      this.pdiv.appendChild(this.pinput);
      this.div.appendChild(this.pdiv);

      document.getElementById("controls").appendChild(this.div);
      this.pinput.addEventListener("input", function(e){
        self.phase = this.value*1;
      });
    }
    this.drawControls();
    return this;
  }

  var emmitters = [
    new emmitter(intRand(WIDTH),intRand(HEIGHT), function(){}, 0,200,15, true),
    new emmitter(intRand(WIDTH),intRand(HEIGHT), function(){}, 0,200,15, true),
    new emmitter(intRand(WIDTH),intRand(HEIGHT), function(){}, 0,200,15+1),
    new emmitter(intRand(WIDTH),intRand(HEIGHT), function(){}, 0,200,15+1),
  ];

  var CANVASOBJ = function(canvas){
    this.canvas = canvas;
    this.emmitter = 0;
    this.ctx = this.canvas.getContext("2d");
    this.ctx.fillStyle = "black";
    this.ctx.fillRect(0, 0, this.canvas.width,  this.canvas.height);
    this.drawing=true;

    this.canvas.addEventListener('mousedown', function(e){
      if(this.drawing==false)
      {
        this.emmitter++;
        if(this.emmitter >= emmitters.length)
        this.emmitter=0;
        this.drawing=true;
      }
    }.bind(this));

    this.canvas.addEventListener('mouseup', function(e){
      this.drawing=false;
    }.bind(this));

    this.canvas.addEventListener('mousemove', function(e){
      if(this.drawing)
      {
        var rect = this.canvas.getBoundingClientRect();
        var x = (e.clientX - rect.left) * this.canvas.width / this.canvas.clientWidth;
        var y = (e.clientY - rect.top) * this.canvas.height / this.canvas.clientHeight;
        emmitters[this.emmitter].x=x;
        emmitters[this.emmitter].y=y;
      }
    }.bind(this));

    this.pass = function() {
      if(this.ctx){
        var imgData = this.ctx.getImageData(0, 0, this.canvas.width,  this.canvas.height);
        var data = imgData.data;

        for (var i = 0; i < data.length; i += 4) {
          SHADER01(data, i);
        }
        this.ctx.putImageData(imgData, 0, 0);
      }
    };

    this.rIndexData = function(data, i, ix, iy){
      if(!data){
        var imgData = this.ctx.getImageData(0, 0, this.canvas.width,  this.canvas.height);
        var data = imgData.data;
      }
      var ni = i + ((ix+(iy*this.canvas.width))*4);
      if((ni>=0)&&(ni<=data.length))
      return ni;
      return null;
    }

    this.render = function (){
      this.pass();
      for(var j =0; j<emmitters.length; j++)
      {
        if(emmitters[j].checked)
        {
          this.ctx.strokeStyle="#0f0";
          this.ctx.strokeRect(emmitters[j].x-10,emmitters[j].y-10,20,20);
          this.ctx.font = "8px Monospace";
          this.ctx.fillText(emmitters[j].f+", "+Math.floor(emmitters[j].a), emmitters[j].x-10,emmitters[j].y-10 )
        }
      }
      globaltimer+=globalrate;
      //console.log(globaltimer);
      requestAnimationFrame(this.render.bind(this));
    }
    return this;
  }


  var SHADER01 = function(data, i){

    var x = (i/4)%WIDTH;
    var y = Math.floor((i/4)/WIDTH);
    var c = 0;
    var d = 0;
    for(var j =0; j<emmitters.length; j++)
    {
      if(emmitters[j].checked)
      {
        var offset = (emmitters[j].animate)?globaltimer:0;
        emmitters[j].d = Math.sqrt(Math.pow(x - emmitters[j].x,2)+Math.pow(y - emmitters[j].y, 2));
        var ca = (Math.sin(emmitters[j].d*(emmitters[j].f/1000)-((emmitters[j].phase/100) + offset)));
        c += ca*(1/emmitters[j].d*emmitters[j].a);
      }
    }
    c = (c*127)+127;
    data[i+0]= c;
    data[i+1]= (c>125&&c<129&&drawNullPattern)?255:c;
    data[i+2]= c;
  }
  var cnv = new CANVASOBJ(canvas);
  cnv.render();
  </script>
</body>
</html>
