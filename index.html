<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title> interferencePatternJsToy</title>
  <meta name="description" content="interferencePatternJsToy">
  <meta name="author" content="tixlegeek">

  <style>
  html, body {

  }
  * {
    box-sizing: border-box;
  }
  .rangeCombo {
    border: 1px solid #888;
    border-radius: 5px;
    box-sizing: border-box;
    width: 50%;
    padding: 5px;

    display: inline-block;
  }

  .inputCombo {
    line-height: 35px;
    vertical-align: middle;
  }

  .inputCombo  input[type=text]{
    margin-left: 10px;
    float: right;
    width: 50px;
  }
  .inputCombo input[type=range]
  {
    float: right;
    width: 200px;
  }
  .inputCombo input[type=checkbox] {
    display: inline-block;
    float: right;
    width: 30px;
  }
  #video {
    padding: 5px;
    width: 1024px;
    clear:both;
    border: 1px solid #888;
    border-radius: 5px;
    box-sizing: border-box;
    margin: auto;
    margin-bottom: 10px;
  }
  #video canvas{
    display: block;
    margin: 10px auto;
    padding: 5px;
    border: 1px solid #888;
    width:90%;
  }

  #title {
    padding: 5px;
    width: 1024px;
    clear:both;
    border: 1px solid #888;
    border-radius: 5px;
    box-sizing: border-box;
    margin: auto;
  }
  #controls {
    padding: 5px;
    width: 1024px;
    clear:both;
    border: 1px solid #888;
    border-radius: 5px;
    margin: auto;
  }
  </style>
</head>

<body>
  <div id="title">
    <h1>Simple interference pattern visualisation tool</h1>
    <h2>About:</h2>
    <p>
      Developped on the 03-05-2020, by <a href="https://twitter.com/tixlegeek/">@tixlegeek</a> (aka <a href="https://twitter.com/captnlarzuk/">@captnlarzuk</a> ).
    </p>
    <p>
      Simple and dirty JS toy which lets you play with interference patterns.

      This code is absolutely not finished, or cleaned up, and i got no time today for that.
    </p>
    <h2>About physics:</h2>
    <p>
      I can't say it's a physics-accurate representation. I made that for quick testings, but, i guess i now have to think about the "simulation" side. For example, you can't yet simulate reverberation, diffraction, etc... just isotropic emmiters, with a Frequency, a Phase, and an Amplitude (which you can tweak). You also can try to move them around, but, beware, the selector is a ring-buffer, so using it is a pain in the ass.
    </p>
    <p>
      Yes, UI is aweful. Have fun!
    </p>
  </div>
  <div id="video">
    <p>Selection and displacement of emmitters is a rotating buffer. Click and drag to experience the true bontempi UI.</p>
    <canvas id="canvas" width="320" height="200" >
    </canvas>
  </div>
  <div id="controls">
    <div class="rangeCombo" id="generalControls">

    </div>
  </div>
  <script>
  var intRand = function(i){
    return Math.floor(Math.random() * Math.floor(i));
  }
  var globaltimer=0;
  var globalrate=0.01;
  var drawNullPattern = false;


  var canvas =  document.getElementById('canvas');

  var WIDTH = canvas.width;
  var HEIGHT = canvas.height;


  var control = function(parent=document.body, type="range", def=0, args={}, name="control", text="Control:", eventId, callback)
  {
    this.type = type;
    this.parent = parent;
    this.args = args;
    this.name = name;
    this.text = text;
    this.eventId = eventId;
    this.callback = callback;
    this.value=def;
    this.input = document.createElement("INPUT");
    this.mon = document.createElement("INPUT");
    this.div=document.createElement("DIV");
    this.label=document.createElement("LABEL");

    this.changed = function(){
      if(this.type=="checkbox")
      {
        this.value = this.input.checked?"true":"false";
        this.mon.value = this.value;
      }
      else
      {
        this.value = this.input.value;
        this.mon.value = this.value;
      }
    };
    this.draw = function(){
      this.div.classList.add("inputCombo");
      this.mon.setAttribute("type", "text");
      this.mon.setAttribute("name", this.name+"_mon");
      this.mon.value = this.value;
      this.mon.classList.add("mon_input");

      this.label.setAttribute("for", this.name);
      this.label.innerHTML = this.text;

      switch (this.type) {
        case "range":
        this.input.setAttribute("type", "range");
        this.input.setAttribute("name", this.name);
        this.input.setAttribute("max", this.args.max || 100);
        this.input.setAttribute("min", this.args.min || 0);
        this.input.setAttribute("step", this.args.step || 1);
        this.input.value = this.value;
        this.input.addEventListener(this.eventId, callback.bind(this));
        this.div.appendChild(this.label);
        this.div.appendChild(this.mon);
        this.div.appendChild(this.input);
        break;
        case "checkbox":
        this.input.setAttribute("type", "checkbox");
        this.input.setAttribute("name", this.name);
        this.input.checked = (this.value==false)?false:true;
        this.input.addEventListener(this.eventId, callback.bind(this));
        this.div.appendChild(this.label);
        this.div.appendChild(this.input);
        break;
        default:

      }
      //this.mon.addEventListener("change",function(e){ this.value=this.mon.value; this.changed();}.bind(this));
      this.parent.appendChild(this.div);
    }

    this.draw();
    return this;
  };
  var emmitter = function(x,y,step, phase=0, f=100, a=50, active=false){
    this.x = x;
    this.y = y;

    this.f = f;
    this.a = a;
    this.phase = phase;
    this.step = step;
        this.d = 0;

    this.animate = false;
    this.offset = 0;
    this.checked = active;

    this.checkedinput=document.createElement("INPUT");
    this.animateinput=document.createElement("INPUT");
    this.ainput=document.createElement("INPUT");
    this.adiv=document.createElement("DIV");
    this.finput=document.createElement("INPUT");
    this.fdiv=document.createElement("DIV");
    this.pinput=document.createElement("INPUT");
    this.pdiv=document.createElement("DIV");
    this.div=document.createElement("DIV");

    this.drawControls = function(){
      var self=this;
      this.div.classList.add("rangeCombo");
      new control(this.div,"checkbox",this.checked, {},"active","Activate :", "click",function(e){self.checked = this.value = this.input.checked;this.changed();});
      new control(this.div,"checkbox",this.animate, {},"animate","Animated :", "click",function(e){self.animate = this.value = this.input.checked;this.changed();});
      new control(this.div,"range",this.f, {max:500, min:1, step:0.5},"freq","Frequency :", "input",function(e){self.f = this.input.value * 1;this.changed();});
      new control(this.div,"range",this.phase, {max:2*Math.PI*100, min:0, step:0.05},"phas","Phase :", "input",function(e){self.phase = this.input.value * 1;this.changed();});
      new control(this.div,"range",this.a, {max:100, min:0, step:1},"ampl","Amplification :", "input",function(e){self.a = this.input.value * 1;this.changed();});
      document.getElementById("controls").appendChild(this.div);
    }

    this.drawControls();
    return this;
  }

  new control(document.getElementById("generalControls"),"range",globalrate, { 'max':1,'min':-1, 'step':.01},"globalrate","Animation Rate:", "input",function(e){globalrate = this.value*1;this.changed();});
  new control(document.getElementById("generalControls"),"checkbox",drawNullPattern, {},"animate","Animated :", "click",function(e){drawNullPattern = this.value = this.input.checked;this.changed();});

  var emmitters = [
    new emmitter(intRand(WIDTH),intRand(HEIGHT), function(){}, 0,200,15, true),
    new emmitter(intRand(WIDTH),intRand(HEIGHT), function(){}, 0,200,15, true),
    new emmitter(intRand(WIDTH),intRand(HEIGHT), function(){}, 0,200,15+1),
    new emmitter(intRand(WIDTH),intRand(HEIGHT), function(){}, 0,200,15+1),
  ];

  var CANVASOBJ = function(canvas){
    this.canvas = canvas;
    this.emmitter = 0;
    this.ctx = this.canvas.getContext("2d");
    this.ctx.fillStyle = "black";
    this.ctx.fillRect(0, 0, this.canvas.width,  this.canvas.height);
    this.drawing=true;

    this.canvas.addEventListener('mousedown', function(e){
      if(this.drawing==false)
      {
        this.emmitter++;
        if(this.emmitter >= emmitters.length)
        this.emmitter=0;
        this.drawing=true;
      }
    }.bind(this));

    this.canvas.addEventListener('mouseup', function(e){
      this.drawing=false;
    }.bind(this));

    this.canvas.addEventListener('mousemove', function(e){
      if(this.drawing)
      {
        var rect = this.canvas.getBoundingClientRect();
        var x = (e.clientX - rect.left) * this.canvas.width / this.canvas.clientWidth;
        var y = (e.clientY - rect.top) * this.canvas.height / this.canvas.clientHeight;
        emmitters[this.emmitter].x=x;
        emmitters[this.emmitter].y=y;
      }
    }.bind(this));

    this.pass = function() {
      if(this.ctx){
        var imgData = this.ctx.getImageData(0, 0, this.canvas.width,  this.canvas.height);
        var data = imgData.data;

        for (var i = 0; i < data.length; i += 4) {
          SHADER01(data, i);
        }
        this.ctx.putImageData(imgData, 0, 0);
      }
    };

    this.rIndexData = function(data, i, ix, iy){
      if(!data){
        var imgData = this.ctx.getImageData(0, 0, this.canvas.width,  this.canvas.height);
        var data = imgData.data;
      }
      var ni = i + ((ix+(iy*this.canvas.width))*4);
      if((ni>=0)&&(ni<=data.length))
      return ni;
      return null;
    }

    this.render = function (){
      this.pass();
      for(var j =0; j<emmitters.length; j++)
      {
        if(emmitters[j].checked)
        {
          this.ctx.strokeStyle="#0f0";
          this.ctx.strokeRect(emmitters[j].x-10,emmitters[j].y-10,20,20);
          this.ctx.font = "8px Monospace";
          this.ctx.fillText(emmitters[j].f+", "+Math.floor(emmitters[j].a), emmitters[j].x-10,emmitters[j].y-10 )
        }
      }
      globaltimer+=globalrate;
      //console.log(globaltimer);
      requestAnimationFrame(this.render.bind(this));
    }
    return this;
  }


  var SHADER01 = function(data, i){

    var x = (i/4)%WIDTH;
    var y = Math.floor((i/4)/WIDTH);
    var c = 0;
    var d = 0;
    for(var j =0; j<emmitters.length; j++)
    {
      if(emmitters[j].checked)
      {
        var offset = (emmitters[j].animate)?globaltimer:0;
        emmitters[j].d = Math.sqrt(Math.pow(x - emmitters[j].x,2)+Math.pow(y - emmitters[j].y, 2));
        var ca = (Math.sin(emmitters[j].d*(emmitters[j].f/1000)-((emmitters[j].phase/100) + offset)));
        c += ca*(1/emmitters[j].d*emmitters[j].a);
      }
    }
    c = (c*127)+127;
    data[i+0]= c;
    data[i+1]= (c>125&&c<129&&drawNullPattern)?255:c;
    data[i+2]= c;
  }
  var cnv = new CANVASOBJ(canvas);

  cnv.render();
</script>
</body>
</html>
